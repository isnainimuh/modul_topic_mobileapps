import 'package:flutter/foundation.dart';
import '../models/product.dart';
import '../models/category.dart' as my_category;
import '../services/api_service.dart';
import 'auth_provider.dart'; // Tambahkan ini

class ProductProvider with ChangeNotifier {
  List<Product> _products = [];
  List<my_category.Category> _categories = [];
  List<Product> _featuredProducts = [];
  bool _isLoading = false;
  String _searchQuery = '';
  int? _selectedCategoryId;
  String _error = '';

  final AuthProvider authProvider; // Tambahkan ini

  // Constructor yang menerima AuthProvider
  ProductProvider(this.authProvider);

  // Getters
  List<Product> get products => _products;
  List<my_category.Category> get categories => _categories;
  List<Product> get featuredProducts => _featuredProducts;
  bool get isLoading => _isLoading;
  String get searchQuery => _searchQuery;
  int? get selectedCategoryId => _selectedCategoryId;
  String get error => _error;

  // Fetch all products dengan error handling
  Future<void> fetchProducts({int? categoryId, String? search}) async {
    _isLoading = true;
    _error = '';
    notifyListeners();
    //print('Fetching products...');

    try {
      List<Product> allProducts =
          await ApiService.getProducts(authProvider.token);
      //print('Products count: ${allProducts.length}');

      // Filter by category if provided
      if (categoryId != null) {
        allProducts = allProducts
            .where((product) => product.category.categoryId == categoryId)
            .toList();
      }

      // Filter by search query if provided
      if (search != null && search.isNotEmpty) {
        allProducts = allProducts
            .where((product) =>
                product.productName
                    .toLowerCase()
                    .contains(search.toLowerCase()) ||
                product.description
                    .toLowerCase()
                    .contains(search.toLowerCase()))
            .toList();
      }

      _products = allProducts;
      _error = '';
    } catch (e) {
      _error = 'Failed to load products: $e';
      //print('Error: $_error'); //
      if (kDebugMode) {
        print('Error fetching products: $e');
      }
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Fetch featured products dengan error handling
  Future<void> fetchFeaturedProducts() async {
    try {
      _featuredProducts = await ApiService.getFeaturedProducts();
    } catch (e) {
      _error = 'Failed to load featured products: $e';
      if (kDebugMode) {
        print('Error fetching featured products: $e');
      }
    }
    notifyListeners();
  }

  // Fetch categories dengan error handling
  Future<void> fetchCategories() async {
    try {
      _categories = await ApiService.getCategories();
    } catch (e) {
      _error = 'Failed to load categories: $e';
      if (kDebugMode) {
        print('Error fetching categories: $e');
      }
    }
    notifyListeners();
  }

  // Search & Filter methods tetap sama...
  void setSearchQuery(String query) {
    _searchQuery = query;
    notifyListeners();
  }

  void setSelectedCategory(int? categoryId) {
    _selectedCategoryId = categoryId;
    notifyListeners();
  }

  void clearFilters() {
    _searchQuery = '';
    _selectedCategoryId = null;
    notifyListeners();
    fetchProducts();
  }

  Product? getProductById(int productId) {
    try {
      return _products.firstWhere((product) => product.productId == productId);
    } catch (e) {
      return null;
    }
  }

  List<Product> getProductsByCategory(int categoryId) {
    return _products
        .where((product) => product.category.categoryId == categoryId)
        .toList();
  }

  Future<void> applyFilters() async {
    _isLoading = true;
    notifyListeners();

    try {
      List<Product> filteredProducts =
          await ApiService.getProducts(authProvider.token);

      if (_selectedCategoryId != null) {
        filteredProducts = filteredProducts
            .where(
                (product) => product.category.categoryId == _selectedCategoryId)
            .toList();
      }

      if (_searchQuery.isNotEmpty) {
        filteredProducts = filteredProducts
            .where((product) =>
                product.productName
                    .toLowerCase()
                    .contains(_searchQuery.toLowerCase()) ||
                product.description
                    .toLowerCase()
                    .contains(_searchQuery.toLowerCase()))
            .toList();
      }

      _products = filteredProducts;
    } catch (e) {
      _error = 'Failed to apply filters: $e';
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> refreshProducts() async {
    await fetchProducts(
      categoryId: _selectedCategoryId,
      search: _searchQuery.isNotEmpty ? _searchQuery : null,
    );
  }

  List<Product> get filteredProducts {
    List<Product> filtered = _products;

    if (_selectedCategoryId != null) {
      filtered = filtered
          .where(
              (product) => product.category.categoryId == _selectedCategoryId)
          .toList();
    }

    if (_searchQuery.isNotEmpty) {
      filtered = filtered
          .where((product) =>
              product.productName
                  .toLowerCase()
                  .contains(_searchQuery.toLowerCase()) ||
              product.description
                  .toLowerCase()
                  .contains(_searchQuery.toLowerCase()))
          .toList();
    }

    return filtered;
  }

  // Clear error
  void clearError() {
    _error = '';
    notifyListeners();
  }
}
