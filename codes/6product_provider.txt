import 'package:flutter/foundation.dart';
import '../models/product.dart';
import '../models/category.dart' as my_category;
import '../services/api_service.dart';

class ProductProvider with ChangeNotifier {
  List<Product> _products = [];
  List<my_category.Category> _categories = [];
  List<Product> _featuredProducts = [];
  bool _isLoading = false;
  String _searchQuery = '';
  int? _selectedCategoryId;

  List<Product> get products => _products;
  List<my_category.Category> get categories => _categories;
  List<Product> get featuredProducts => _featuredProducts;
  bool get isLoading => _isLoading;
  String get searchQuery => _searchQuery;
  int? get selectedCategoryId => _selectedCategoryId;

  // Products
  Future<void> fetchProducts({int? categoryId, String? search}) async {
    _isLoading = true;
    notifyListeners();

    try {
      List<Product> allProducts = await ApiService.getProducts();

      // Filter by category if provided
      if (categoryId != null) {
        allProducts = allProducts
            .where((product) => product.category.categoryId == categoryId)
            .toList();
      }

      // Filter by search query if provided
      if (search != null && search.isNotEmpty) {
        allProducts = allProducts
            .where((product) =>
                product.name.toLowerCase().contains(search.toLowerCase()) ||
                product.description
                    .toLowerCase()
                    .contains(search.toLowerCase()))
            .toList();
      }

      _products = allProducts;
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  Future<void> fetchFeaturedProducts() async {
    try {
      _featuredProducts = await ApiService.getFeaturedProducts();
      notifyListeners();
    } catch (e) {
      rethrow;
    }
  }

  // Categories
  Future<void> fetchCategories() async {
    try {
      _categories = await ApiService.getCategories();
      notifyListeners();
    } catch (e) {
      rethrow;
    }
  }

  // Search & Filter
  void setSearchQuery(String query) {
    _searchQuery = query;
    notifyListeners();
  }

  void setSelectedCategory(int? categoryId) {
    _selectedCategoryId = categoryId;
    notifyListeners();
  }

  void clearFilters() {
    _searchQuery = '';
    _selectedCategoryId = null;
    notifyListeners();
    fetchProducts(); // Refresh tanpa filter
  }

  // Get product by ID
  Product? getProductById(int productId) {
    try {
      return _products.firstWhere((product) => product.productId == productId);
    } catch (e) {
      return null;
    }
  }

  // Get products by category
  List<Product> getProductsByCategory(int categoryId) {
    return _products
        .where((product) => product.category.categoryId == categoryId)
        .toList();
  }

  // Apply filters (combine search and category) - FIXED: removed await
  Future<void> applyFilters() async {
    _isLoading = true;
    notifyListeners();

    try {
      List<Product> filteredProducts = await ApiService.getProducts();

      // Apply category filter
      if (_selectedCategoryId != null) {
        filteredProducts = filteredProducts
            .where(
                (product) => product.category.categoryId == _selectedCategoryId)
            .toList();
      }

      // Apply search filter
      if (_searchQuery.isNotEmpty) {
        filteredProducts = filteredProducts
            .where((product) =>
                product.name
                    .toLowerCase()
                    .contains(_searchQuery.toLowerCase()) ||
                product.description
                    .toLowerCase()
                    .contains(_searchQuery.toLowerCase()))
            .toList();
      }

      _products = filteredProducts;
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      _isLoading = false;
      notifyListeners();
      rethrow;
    }
  }

  // Refresh products with current filters
  Future<void> refreshProducts() async {
    await fetchProducts(
      categoryId: _selectedCategoryId,
      search: _searchQuery.isNotEmpty ? _searchQuery : null,
    );
  }

  // Get filtered products based on current filters (for UI)
  List<Product> get filteredProducts {
    List<Product> filtered = _products;

    // Apply category filter
    if (_selectedCategoryId != null) {
      filtered = filtered
          .where(
              (product) => product.category.categoryId == _selectedCategoryId)
          .toList();
    }

    // Apply search filter
    if (_searchQuery.isNotEmpty) {
      filtered = filtered
          .where((product) =>
              product.name.toLowerCase().contains(_searchQuery.toLowerCase()) ||
              product.description
                  .toLowerCase()
                  .contains(_searchQuery.toLowerCase()))
          .toList();
    }

    return filtered;
  }
}
